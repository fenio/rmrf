name: 'GTFO'
description: 'Get The F*** Out - Analyze and reclaim disk space on GitHub runners'
author: 'fenio'

branding:
  icon: 'trash-2'
  color: 'red'

inputs:
  remove-android:
    description: 'Remove Android SDK (~12GB)'
    required: false
    default: 'true'
  remove-dotnet:
    description: 'Remove .NET SDK (~2GB)'
    required: false
    default: 'true'
  remove-haskell:
    description: 'Remove GHC/Haskell (~2GB)'
    required: false
    default: 'true'
  remove-boost:
    description: 'Remove Boost (~1GB)'
    required: false
    default: 'true'
  remove-swift:
    description: 'Remove Swift (~1.5GB)'
    required: false
    default: 'true'
  remove-docker-images:
    description: 'Remove Docker images'
    required: false
    default: 'false'
  merge-disks:
    description: 'Merge root and /mnt into single LVM volume'
    required: false
    default: 'false'
  use-btrfs:
    description: 'Use Btrfs with zstd compression (requires merge-disks: true)'
    required: false
    default: 'false'

runs:
  using: 'composite'
  steps:
    # ============================================
    # PHASE 1: Record initial disk state
    # ============================================
    - name: Record initial disk state
      shell: bash
      run: |
        echo "============================================"
        echo "  GTFO - Initial Disk State"
        echo "============================================"
        echo ""
        df -h
        echo ""
        
        # Save initial values for summary
        echo "INITIAL_ROOT_AVAIL=$(df / --output=avail -BG | tail -1 | tr -d ' G')" >> $GITHUB_ENV
        echo "INITIAL_ROOT_USED=$(df / --output=used -BG | tail -1 | tr -d ' G')" >> $GITHUB_ENV
        
        if mountpoint -q /mnt 2>/dev/null; then
          echo "INITIAL_MNT_AVAIL=$(df /mnt --output=avail -BG | tail -1 | tr -d ' G')" >> $GITHUB_ENV
          echo ">>> /mnt is mounted ($(df -h /mnt --output=size | tail -1 | tr -d ' ') total, $(df -h /mnt --output=avail | tail -1 | tr -d ' ') available)"
        fi

    # ============================================
    # PHASE 2: Install rmz for fast deletion
    # ============================================
    - name: Install rmz
      shell: bash
      run: |
        echo ">>> Installing rmz (fast rm alternative)..."
        curl -sL https://github.com/SUPERCILEX/fuc/releases/download/3.1.1/x86_64-unknown-linux-gnu-rmz -o /tmp/rmz
        chmod +x /tmp/rmz
        echo "rmz installed successfully"

    # ============================================
    # PHASE 3: Remove bloat
    # ============================================
    - name: Remove bloat
      shell: bash
      env:
        REMOVE_ANDROID: ${{ inputs.remove-android }}
        REMOVE_DOTNET: ${{ inputs.remove-dotnet }}
        REMOVE_HASKELL: ${{ inputs.remove-haskell }}
        REMOVE_BOOST: ${{ inputs.remove-boost }}
        REMOVE_SWIFT: ${{ inputs.remove-swift }}
        REMOVE_DOCKER: ${{ inputs.remove-docker-images }}
      run: |
        echo "============================================"
        echo "  Removing bloat..."
        echo "============================================"
        echo ""
        
        paths=()
        
        if [[ "$REMOVE_ANDROID" == "true" ]]; then
          echo "- Marking Android SDK for removal"
          paths+=("/usr/local/lib/android")
        fi
        
        if [[ "$REMOVE_DOTNET" == "true" ]]; then
          echo "- Marking .NET SDK for removal"
          paths+=("/usr/share/dotnet")
        fi
        
        if [[ "$REMOVE_HASKELL" == "true" ]]; then
          echo "- Marking Haskell/GHC for removal"
          [[ -d "/opt/ghc" ]] && paths+=("/opt/ghc")
          [[ -d "/usr/local/.ghcup" ]] && paths+=("/usr/local/.ghcup")
        fi
        
        if [[ "$REMOVE_BOOST" == "true" ]]; then
          echo "- Marking Boost for removal"
          paths+=("/usr/local/share/boost")
        fi
        
        if [[ "$REMOVE_SWIFT" == "true" ]]; then
          echo "- Marking Swift for removal"
          paths+=("/usr/share/swift")
        fi
        
        echo ""
        
        if [[ ${#paths[@]} -gt 0 ]]; then
          echo "Removing ${#paths[@]} directories with rmz..."
          echo "Paths: ${paths[*]}"
          echo ""
          
          # Filter to only existing paths
          existing_paths=()
          for p in "${paths[@]}"; do
            if [[ -e "$p" ]]; then
              existing_paths+=("$p")
            else
              echo "Skipping non-existent: $p"
            fi
          done
          
          if [[ ${#existing_paths[@]} -gt 0 ]]; then
            time sudo /tmp/rmz "${existing_paths[@]}"
            echo ""
            echo "Removal complete!"
          else
            echo "No paths to remove."
          fi
        else
          echo "No directories marked for removal."
        fi
        
        # Docker images handled separately
        if [[ "$REMOVE_DOCKER" == "true" ]]; then
          echo ""
          echo "Removing Docker images..."
          docker system prune -af || true
        fi
        
        echo ""

    # ============================================
    # PHASE 4: Merge disks (optional)
    # ============================================
    - name: Merge disks into LVM volume
      if: ${{ inputs.merge-disks == 'true' }}
      shell: bash
      env:
        USE_BTRFS: ${{ inputs.use-btrfs }}
      run: |
        echo "============================================"
        echo "  Merging disks into LVM volume..."
        echo "============================================"
        echo ""
        
        set -e  # Exit on error
        
        # Install LVM tools if not present
        if ! command -v pvcreate &> /dev/null; then
          echo ">>> Installing LVM tools..."
          sudo apt-get update -qq
          sudo apt-get install -y -qq lvm2
        else
          echo ">>> LVM tools already installed"
        fi
        
        if [[ "$USE_BTRFS" == "true" ]]; then
          if ! command -v mkfs.btrfs &> /dev/null; then
            echo ">>> Installing Btrfs tools..."
            [[ -f /var/lib/apt/lists/lock ]] || sudo apt-get update -qq
            sudo apt-get install -y -qq btrfs-progs
          else
            echo ">>> Btrfs tools already installed"
          fi
        fi
        
        # Disable swap
        echo ""
        echo ">>> Disabling swap..."
        sudo swapoff -a || true
        
        # Unmount /mnt
        echo ">>> Unmounting /mnt..."
        # Get the device for /mnt before unmounting
        MNT_DEVICE=$(df /mnt --output=source | tail -1)
        echo ">>> /mnt is on device: $MNT_DEVICE"
        sudo umount /mnt || true
        
        # Calculate loopback size (80% of available root space)
        avail_kb=$(df / --output=avail | tail -1 | tr -d ' ')
        avail_gb=$((avail_kb / 1024 / 1024))
        loop_size=$((avail_gb * 80 / 100))
        
        # Ensure minimum size of 10GB
        if [[ $loop_size -lt 10 ]]; then
          loop_size=10
        fi
        
        echo ""
        echo ">>> Available space on root: ${avail_gb}GB"
        echo ">>> Creating ${loop_size}GB loopback file..."
        
        # Create loopback file
        sudo fallocate -l ${loop_size}G /space.img
        
        # Find available loop device
        loop_dev=$(sudo losetup -f)
        echo ">>> Using loop device: $loop_dev"
        sudo losetup "$loop_dev" /space.img
        
        # Create LVM physical volumes (force to overwrite existing signatures)
        echo ""
        echo ">>> Creating LVM physical volumes..."
        sudo pvcreate -ff -y "$MNT_DEVICE"
        sudo pvcreate -ff -y "$loop_dev"
        
        # Create volume group
        echo ">>> Creating volume group 'workspace'..."
        sudo vgcreate workspace "$MNT_DEVICE" "$loop_dev"
        
        # Create logical volume
        echo ">>> Creating logical volume 'work'..."
        sudo lvcreate -l 100%FREE -n work workspace
        
        # Show LVM info
        echo ""
        echo ">>> LVM configuration:"
        sudo vgdisplay workspace
        
        # Format the volume
        echo ""
        if [[ "$USE_BTRFS" == "true" ]]; then
          echo ">>> Formatting as Btrfs with zstd compression..."
          sudo mkfs.btrfs -f /dev/workspace/work
          
          echo ">>> Mounting at /home/runner/work..."
          sudo mount -o compress=zstd /dev/workspace/work /home/runner/work
        else
          echo ">>> Formatting as ext4..."
          sudo mkfs.ext4 -F /dev/workspace/work
          
          echo ">>> Mounting at /home/runner/work..."
          sudo mount /dev/workspace/work /home/runner/work
        fi
        
        # Fix ownership
        echo ">>> Fixing ownership..."
        sudo chown -R runner:runner /home/runner/work
        
        echo ""
        echo ">>> Disk merge complete!"

    # ============================================
    # PHASE 5: Summary
    # ============================================
    - name: Summary
      shell: bash
      env:
        MERGE_DISKS: ${{ inputs.merge-disks }}
      run: |
        echo ""
        echo "============================================"
        echo "  GTFO - Summary"
        echo "============================================"
        echo ""
        
        df -h
        echo ""
        
        # Calculate space gained
        FINAL_ROOT_AVAIL=$(df / --output=avail -BG | tail -1 | tr -d ' G')
        FINAL_ROOT_USED=$(df / --output=used -BG | tail -1 | tr -d ' G')
        
        ROOT_FREED=$((FINAL_ROOT_AVAIL - INITIAL_ROOT_AVAIL))
        
        echo "============================================"
        echo "  Space Report"
        echo "============================================"
        echo ""
        echo "Root filesystem (/):"
        echo "  Before: ${INITIAL_ROOT_USED}GB used, ${INITIAL_ROOT_AVAIL}GB available"
        echo "  After:  ${FINAL_ROOT_USED}GB used, ${FINAL_ROOT_AVAIL}GB available"
        echo "  Freed:  ${ROOT_FREED}GB"
        echo ""
        
        if [[ "$MERGE_DISKS" == "true" ]]; then
          WORKSPACE_AVAIL=$(df /home/runner/work --output=avail -BG | tail -1 | tr -d ' G')
          WORKSPACE_SIZE=$(df /home/runner/work --output=size -BG | tail -1 | tr -d ' G')
          echo "Merged workspace (/home/runner/work):"
          echo "  Total size: ${WORKSPACE_SIZE}GB"
          echo "  Available:  ${WORKSPACE_AVAIL}GB"
          echo ""
          echo "Combined from:"
          echo "  - Loopback from root (~${ROOT_FREED}GB * 80%)"
          echo "  - /mnt disk (~${INITIAL_MNT_AVAIL:-74}GB)"
        fi
        
        echo ""
        echo "============================================"
        echo "  GTFO complete!"
        echo "============================================"
