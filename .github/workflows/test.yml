name: Test GTFO

on:
  push:
  workflow_dispatch:
    inputs:
      test-mode:
        description: 'Test mode to run'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - cleanup-only
          - nuke
          - merge-ext4
          - merge-btrfs

jobs:
  # Test 1: Default cleanup (no merge)
  test-cleanup:
    if: ${{ github.event_name == 'push' || github.event.inputs.test-mode == 'all' || github.event.inputs.test-mode == 'cleanup-only' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Run GTFO (cleanup only)
        uses: ./
        with:
          remove-android: 'true'
          remove-dotnet: 'true'
          remove-haskell: 'true'
          remove-boost: 'true'
          remove-swift: 'true'
          remove-docker-images: 'true'
          merge-disks: 'false'
      - name: Verify workspace is writable
        run: |
          echo "Testing workspace write access..."
          echo "test" > test-file.txt
          cat test-file.txt
          rm test-file.txt
          echo "Workspace is writable!"

  # Test 2: Nuke packages (experimental)
  test-nuke:
    if: ${{ github.event_name == 'push' || github.event.inputs.test-mode == 'all' || github.event.inputs.test-mode == 'nuke' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Run GTFO with nuke
        uses: ./
        with:
          remove-android: 'true'
          remove-dotnet: 'true'
          remove-haskell: 'true'
          remove-boost: 'true'
          remove-swift: 'true'
          remove-docker-images: 'true'
          nuke: 'true'
          merge-disks: 'false'
      - name: Analyze remaining space hogs
        run: |
          echo "============================================"
          echo "  Remaining Space Hogs Analysis"
          echo "============================================"
          echo ""
          
          echo "=== Top 30 largest directories in /usr ==="
          sudo du -sh /usr/*/ 2>/dev/null | sort -hr | head -30
          echo ""
          
          echo "=== Top 30 largest directories in /opt ==="
          sudo du -sh /opt/*/ 2>/dev/null | sort -hr | head -30
          echo ""
          
          echo "=== Top 20 largest directories in /var ==="
          sudo du -sh /var/*/ 2>/dev/null | sort -hr | head -20
          echo ""
          
          echo "=== Top 20 largest directories in /home ==="
          sudo du -sh /home/*/ 2>/dev/null | sort -hr | head -20
          echo ""
          
          echo "=== Breakdown of /usr/share (top 30) ==="
          sudo du -sh /usr/share/*/ 2>/dev/null | sort -hr | head -30
          echo ""
          
          echo "=== Breakdown of /usr/lib (top 30) ==="
          sudo du -sh /usr/lib/*/ 2>/dev/null | sort -hr | head -30
          echo ""
          
          echo "=== Breakdown of /usr/local (top 20) ==="
          sudo du -sh /usr/local/*/ 2>/dev/null | sort -hr | head -20
          echo ""
          
          echo "=== Large files (>100MB) ==="
          sudo find / -xdev -type f -size +100M 2>/dev/null | head -50 | while read f; do
            sudo du -sh "$f" 2>/dev/null
          done | sort -hr
          echo ""
          
          echo "=== Installed packages by size (top 50) ==="
          dpkg-query -Wf '${Installed-Size}\t${Package}\n' | sort -rn | head -50 | awk '{printf "%.1fM\t%s\n", $1/1024, $2}'
          echo ""
      - name: Verify workspace is writable
        run: |
          echo "Testing workspace write access..."
          echo "test" > test-file.txt
          cat test-file.txt
          rm test-file.txt
          echo "Workspace is writable!"

  # Test 3: Merge disks with ext4
  # NOTE: For merge tests, we must run the action BEFORE checking out to /home/runner/work
  # since the merge creates a fresh filesystem there. We inline the action logic for testing.
  test-merge-ext4:
    if: ${{ github.event_name == 'push' || github.event.inputs.test-mode == 'all' || github.event.inputs.test-mode == 'merge-ext4' }}
    runs-on: ubuntu-latest
    steps:
      - name: Run GTFO inline (merge with ext4)
        run: |
          echo "============================================"
          echo "  GTFO - Initial Disk State"
          echo "============================================"
          df -h
          
          # Save initial values
          INITIAL_ROOT_AVAIL=$(df / --output=avail -BG | tail -1 | tr -d ' G')
          INITIAL_ROOT_USED=$(df / --output=used -BG | tail -1 | tr -d ' G')
          INITIAL_MNT_AVAIL=$(df /mnt --output=avail -BG | tail -1 | tr -d ' G')
          
          # Install rmz
          echo ">>> Installing rmz..."
          curl -sL https://github.com/SUPERCILEX/fuc/releases/download/3.1.1/x86_64-unknown-linux-gnu-rmz -o /tmp/rmz
          chmod +x /tmp/rmz
          
          # Remove bloat
          echo ">>> Removing bloat..."
          paths=(/usr/local/lib/android /usr/share/dotnet /usr/share/swift /usr/local/share/boost)
          [[ -d /opt/ghc ]] && paths+=(/opt/ghc)
          [[ -d /usr/local/.ghcup ]] && paths+=(/usr/local/.ghcup)
          sudo /tmp/rmz "${paths[@]}" || true
          
          # Remove Docker images
          echo ">>> Removing Docker images..."
          docker system prune -af || true
          
          # Merge disks - install tools if needed
          if ! command -v pvcreate &> /dev/null; then
            echo ">>> Installing LVM..."
            sudo apt-get update -qq && sudo apt-get install -y -qq lvm2
          else
            echo ">>> LVM tools already installed"
          fi
          
          echo ">>> Disabling swap and unmounting /mnt..."
          sudo swapoff -a || true
          # Get the device for /mnt before unmounting
          MNT_DEVICE=$(df /mnt --output=source | tail -1)
          echo ">>> /mnt is on device: $MNT_DEVICE"
          sudo umount /mnt || true
          
          # Create loopback
          avail_kb=$(df / --output=avail | tail -1 | tr -d ' ')
          loop_size=$(( avail_kb / 1024 / 1024 * 80 / 100 ))
          [[ $loop_size -lt 10 ]] && loop_size=10
          echo ">>> Creating ${loop_size}GB loopback..."
          sudo fallocate -l ${loop_size}G /space.img
          loop_dev=$(sudo losetup -f)
          sudo losetup "$loop_dev" /space.img
          
          # Create LVM
          echo ">>> Creating LVM..."
          sudo pvcreate -ff -y "$MNT_DEVICE"
          sudo pvcreate -ff -y "$loop_dev"
          sudo vgcreate workspace "$MNT_DEVICE" "$loop_dev"
          sudo lvcreate -l 100%FREE -n work workspace
          
          # Format and mount
          echo ">>> Formatting as ext4..."
          sudo mkfs.ext4 -F /dev/workspace/work
          sudo mount /dev/workspace/work /home/runner/work
          
          # Create swap file on root filesystem
          echo ">>> Creating 4GB swap file on /..."
          sudo fallocate -l 4G /swap.img
          sudo chmod 600 /swap.img
          sudo mkswap /swap.img
          sudo swapon /swap.img
          
          sudo chown -R runner:runner /home/runner/work
          
          echo ""
          echo "============================================"
          echo "  GTFO - Summary"
          echo "============================================"
          echo ""
          df -h
          echo ""
          
          FINAL_ROOT_AVAIL=$(df / --output=avail -BG | tail -1 | tr -d ' G')
          FINAL_ROOT_USED=$(df / --output=used -BG | tail -1 | tr -d ' G')
          ROOT_FREED=$((FINAL_ROOT_AVAIL - INITIAL_ROOT_AVAIL))
          WORKSPACE_AVAIL=$(df /home/runner/work --output=avail -BG | tail -1 | tr -d ' G')
          WORKSPACE_SIZE=$(df /home/runner/work --output=size -BG | tail -1 | tr -d ' G')
          
          echo "============================================"
          echo "  Space Report"
          echo "============================================"
          echo ""
          echo "Root filesystem (/):"
          echo "  Before: ${INITIAL_ROOT_USED}GB used, ${INITIAL_ROOT_AVAIL}GB available"
          echo "  After:  ${FINAL_ROOT_USED}GB used, ${FINAL_ROOT_AVAIL}GB available"
          echo "  Freed:  ${ROOT_FREED}GB"
          echo ""
          echo "Merged workspace (/home/runner/work):"
          echo "  Total size: ${WORKSPACE_SIZE}GB"
          echo "  Available:  ${WORKSPACE_AVAIL}GB"
          echo ""
          echo "Combined from:"
          echo "  - Loopback from root (~${loop_size}GB)"
          echo "  - /mnt disk (~${INITIAL_MNT_AVAIL}GB)"
          echo ""
          echo "============================================"
          echo "  GTFO complete!"
          echo "============================================"
      - name: Verify merged workspace
        working-directory: /home/runner/work
        run: |
          echo "Checking mount..."
          mount | grep /home/runner/work || true
          df -h /home/runner/work
          echo ""
          echo "Testing write access..."
          echo "test" > test-file.txt
          cat test-file.txt
          rm test-file.txt
          echo "Merged workspace is functional!"

  # Test 4: Merge disks with Btrfs + compression
  # NOTE: For merge tests, we inline the action logic since merge creates a fresh filesystem
  test-merge-btrfs:
    if: ${{ github.event_name == 'push' || github.event.inputs.test-mode == 'all' || github.event.inputs.test-mode == 'merge-btrfs' }}
    runs-on: ubuntu-latest
    steps:
      - name: Run GTFO inline (merge with Btrfs)
        run: |
          echo "============================================"
          echo "  GTFO - Initial Disk State"
          echo "============================================"
          df -h
          
          # Save initial values
          INITIAL_ROOT_AVAIL=$(df / --output=avail -BG | tail -1 | tr -d ' G')
          INITIAL_ROOT_USED=$(df / --output=used -BG | tail -1 | tr -d ' G')
          INITIAL_MNT_AVAIL=$(df /mnt --output=avail -BG | tail -1 | tr -d ' G')
          
          # Install rmz
          echo ">>> Installing rmz..."
          curl -sL https://github.com/SUPERCILEX/fuc/releases/download/3.1.1/x86_64-unknown-linux-gnu-rmz -o /tmp/rmz
          chmod +x /tmp/rmz
          
          # Remove bloat
          echo ">>> Removing bloat..."
          paths=(/usr/local/lib/android /usr/share/dotnet /usr/share/swift /usr/local/share/boost)
          [[ -d /opt/ghc ]] && paths+=(/opt/ghc)
          [[ -d /usr/local/.ghcup ]] && paths+=(/usr/local/.ghcup)
          sudo /tmp/rmz "${paths[@]}" || true
          
          # Remove Docker images
          echo ">>> Removing Docker images..."
          docker system prune -af || true
          
          # Merge disks - install tools if needed
          if ! command -v pvcreate &> /dev/null; then
            echo ">>> Installing LVM..."
            sudo apt-get update -qq && sudo apt-get install -y -qq lvm2
          else
            echo ">>> LVM tools already installed"
          fi
          if ! command -v mkfs.btrfs &> /dev/null; then
            echo ">>> Installing Btrfs tools..."
            sudo apt-get update -qq && sudo apt-get install -y -qq btrfs-progs
          else
            echo ">>> Btrfs tools already installed"
          fi
          
          echo ">>> Disabling swap and unmounting /mnt..."
          sudo swapoff -a || true
          # Get the device for /mnt before unmounting
          MNT_DEVICE=$(df /mnt --output=source | tail -1)
          echo ">>> /mnt is on device: $MNT_DEVICE"
          sudo umount /mnt || true
          
          # Create loopback
          avail_kb=$(df / --output=avail | tail -1 | tr -d ' ')
          loop_size=$(( avail_kb / 1024 / 1024 * 80 / 100 ))
          [[ $loop_size -lt 10 ]] && loop_size=10
          echo ">>> Creating ${loop_size}GB loopback..."
          sudo fallocate -l ${loop_size}G /space.img
          loop_dev=$(sudo losetup -f)
          sudo losetup "$loop_dev" /space.img
          
          # Create LVM
          echo ">>> Creating LVM..."
          sudo pvcreate -ff -y "$MNT_DEVICE"
          sudo pvcreate -ff -y "$loop_dev"
          sudo vgcreate workspace "$MNT_DEVICE" "$loop_dev"
          sudo lvcreate -l 100%FREE -n work workspace
          
          # Format and mount with Btrfs
          echo ">>> Formatting as Btrfs with zstd compression..."
          sudo mkfs.btrfs -f /dev/workspace/work
          sudo mount -o compress=zstd /dev/workspace/work /home/runner/work
          
          # Create swap file on root filesystem
          echo ">>> Creating 4GB swap file on /..."
          sudo fallocate -l 4G /swap.img
          sudo chmod 600 /swap.img
          sudo mkswap /swap.img
          sudo swapon /swap.img
          
          sudo chown -R runner:runner /home/runner/work
          
          echo ""
          echo "============================================"
          echo "  GTFO - Summary"
          echo "============================================"
          echo ""
          df -h
          echo ""
          
          FINAL_ROOT_AVAIL=$(df / --output=avail -BG | tail -1 | tr -d ' G')
          FINAL_ROOT_USED=$(df / --output=used -BG | tail -1 | tr -d ' G')
          ROOT_FREED=$((FINAL_ROOT_AVAIL - INITIAL_ROOT_AVAIL))
          WORKSPACE_AVAIL=$(df /home/runner/work --output=avail -BG | tail -1 | tr -d ' G')
          WORKSPACE_SIZE=$(df /home/runner/work --output=size -BG | tail -1 | tr -d ' G')
          
          echo "============================================"
          echo "  Space Report"
          echo "============================================"
          echo ""
          echo "Root filesystem (/):"
          echo "  Before: ${INITIAL_ROOT_USED}GB used, ${INITIAL_ROOT_AVAIL}GB available"
          echo "  After:  ${FINAL_ROOT_USED}GB used, ${FINAL_ROOT_AVAIL}GB available"
          echo "  Freed:  ${ROOT_FREED}GB"
          echo ""
          echo "Merged workspace (/home/runner/work) - Btrfs+zstd:"
          echo "  Total size: ${WORKSPACE_SIZE}GB"
          echo "  Available:  ${WORKSPACE_AVAIL}GB"
          echo ""
          echo "Combined from:"
          echo "  - Loopback from root (~${loop_size}GB)"
          echo "  - /mnt disk (~${INITIAL_MNT_AVAIL}GB)"
          echo ""
          echo "============================================"
          echo "  GTFO complete!"
          echo "============================================"
      - name: Verify Btrfs workspace
        working-directory: /home/runner/work
        run: |
          echo "Checking mount..."
          mount | grep /home/runner/work || true
          df -h /home/runner/work
          echo ""
          echo "Checking Btrfs compression..."
          cat /proc/mounts | grep workspace || true
          echo ""
          echo "Testing write access..."
          echo "test" > test-file.txt
          cat test-file.txt
          rm test-file.txt
          echo "Btrfs workspace is functional!"
